name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Add SSH key
        run: echo "${{ secrets.EC2_SSH_KEY }}" > /tmp/ssh_key && chmod 600 /tmp/ssh_key

      - name: Determine deployment target
        id: determine-target
        run: |
          current_target=$(ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=10 ec2-user@${{ secrets.LIVE_SERVER_IP }} "sudo cat /home/ec2-user/current_target.txt || (echo 'green' | sudo tee /home/ec2-user/current_target.txt && sudo cat /home/ec2-user/current_target.txt)")
          if [ "$current_target" = "blue" ]; then
            new_target="green"
          else
            new_target="blue"
          fi
          echo "current_target=$current_target" >> $GITHUB_OUTPUT
          echo "new_target=$new_target" >> $GITHUB_OUTPUT
          ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=10 ec2-user@${{ secrets.LIVE_SERVER_IP }} "echo '$new_target' | sudo tee /home/ec2-user/current_target.txt"

      - name: Login to Docker Hub on EC2 instance
        run: |
          ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=10 ec2-user@${{ secrets.LIVE_SERVER_IP }} "echo '${{ secrets.DOCKERHUB_PW }}' | sudo docker login -u '${{ secrets.DOCKERHUB_USERNAME }}' --password-stdin"

      - name: Pull latest image and deploy new version
        run: |
          ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=10 ec2-user@${{ secrets.LIVE_SERVER_IP }} "
            sudo docker pull moaguide/moaguide_back:last
            cd /home/ec2-user
            sudo docker-compose up -d --no-deps \${{ steps.determine-target.outputs.new_target }}
          "

      - name: Health check new environment
        id: health-check
        run: |
          ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=10 ec2-user@${{ secrets.LIVE_SERVER_IP }} "
            health_url=''
            if [ '${{ steps.determine-target.outputs.new_target }}' = 'blue' ]; then
              health_url='https://${{ secrets.Domain }}:8080/hc'
            else
              health_url='https://${{ secrets.Domain }}:8081/hc'
            fi
            for i in {1..10}; do
              http_status=\$(curl -s -o /dev/null -w '%{http_code}' \$health_url)
              if [ \"\$http_status\" -eq \"200\" ]; then
                echo 'Health check passed!'
                exit 0
              fi
              echo 'Waiting for healthy status...'
              sleep 30
            done
            echo 'Health check failed!'
            exit 1
          "

      - name: Update current file
        if: failure()
        run: |
          current_target=$(ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=10 ec2-user@${{ secrets.LIVE_SERVER_IP }} "sudo cat /home/ec2-user/current_target.txt || (echo 'green' | sudo tee /home/ec2-user/current_target.txt && sudo cat /home/ec2-user/current_target.txt)")
          if [ "$current_target" = "blue" ]; then
            new_target="green"
          else
            new_target="blue"
          fi
          echo "current_target=$current_target" >> $GITHUB_OUTPUT
          echo "new_target=$new_target" >> $GITHUB_OUTPUT
          ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=10 ec2-user@${{ secrets.LIVE_SERVER_IP }} "echo '$new_target' | sudo tee /home/ec2-user/current_target.txt"

      - name: Update NGINX configuration and reload
        if: success()
        run: |
          ssh -t -i /tmp/ssh_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=10 ec2-user@${{ secrets.LIVE_SERVER_IP }} "
            sudo sed -i 's/set \\$service_url_backend .*/set \\$service_url_backend ${new_target}_backend;/' /home/ec2-user/nginx.conf
            sudo docker-compose up -d nginx  # Restart NGINX container if not running.
            sudo docker-compose exec nginx nginx -s reload
          "

      - name: Stop old environment
        if: success()
        run: |
          ssh -t -i /tmp/ssh_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=10 ec2-user@${{ secrets.LIVE_SERVER_IP }} "
            if [ '${{ steps.determine-target.outputs.new_target }}' = 'blue' ]; then
              sudo docker-compose stop green
            else
              sudo docker-compose stop blue
            fi
          "
